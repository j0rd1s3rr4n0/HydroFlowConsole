<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>HydroConsole</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#c3d9ff; font-family: Tahoma, sans-serif; }
    .card { box-shadow: 2px 2px 4px #888; }
    #map { position:relative; width:700px; height:350px; margin:auto; border:2px solid #666; background:#222 url('https://dummyimage.com/700x350/aaaaaa/ffffff&text=Presa'); background-size:cover; color:#0f0; }
    #gatecam { position:relative; width:500px; height:220px; margin:20px auto; border:2px solid #666; background:#000 url('https://dummyimage.com/500x220/444/fff&text=Compuertas'); background-size:cover; color:#0f0; }
    #map::after { content:''; position:absolute; inset:0; border:1px solid rgba(255,255,255,0.2); pointer-events:none; }
    .cam-overlay { position:absolute; top:5px; left:5px; background:rgba(0,0,0,0.5); padding:2px 4px; font-size:12px; font-family:monospace; }
    #dam { position:absolute; bottom:100px; left:250px; width:100px; height:100px; background:#555; opacity:0.8; }
    #dam2 { position:absolute; bottom:40px; left:180px; width:140px; height:140px; background:#555; opacity:0.8; }
    .gate { position:absolute; bottom:0; width:15px; height:40px; background:#333; opacity:0.9; }
    .gate2 { position:absolute; bottom:0; width:20px; height:60px; background:#333; opacity:0.9; }
    #gate0 { left:5px; }
    #gate1 { left:25px; }
    #gate2 { left:45px; }
    #gate3 { left:65px; }
    #gate4 { left:85px; }
    #gate2_0 { left:10px; }
    #gate2_1 { left:40px; }
    #gate2_2 { left:70px; }
    #gate2_3 { left:100px; }
    #gate2_4 { left:130px; }
    .flow { position:absolute; bottom:-20px; width:15px; height:20px; background:rgba(0, 170, 255, 0.6); display:none; }
    .flow2 { position:absolute; bottom:-30px; width:20px; height:30px; background:rgba(0,170,255,0.6); display:none; }
    #water { position:absolute; bottom:0; left:0; width:100%; background:rgba(0,0,255,0.4); }
    #water2 { position:absolute; bottom:0; left:0; width:100%; background:rgba(0,0,255,0.4); }
    #city { position:absolute; bottom:0; left:0; width:100%; height:100px; background:#777; opacity:0.9; }
    .house { position:absolute; bottom:10px; width:20px; height:20px; background:#eee; border:1px solid #333; }
    #flood { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,255,0.3); display:none; }
    .cam-cross { position:absolute; top:0; left:0; right:0; bottom:0; pointer-events:none; }
    .cam-cross::before, .cam-cross::after { content:''; position:absolute; background:rgba(255,255,255,0.3); }
    .cam-cross::before { top:50%; left:0; right:0; height:1px; }
    .cam-cross::after { left:50%; top:0; bottom:0; width:1px; }
  </style>
</head>
<body class="container py-3">
  <h1 class="mb-3">Centro de Control - Presa de Tramuntana</h1>
  {% if session %}
  <p>Bienvenido {{ session['user'] }} ({{ session['role'] }}) - <a href="/logout">Salir</a></p>
  {% else %}
  <p><a href="/login/visitante">Iniciar sesión de prueba</a></p>
  {% endif %}
  <div class="card mb-3 w-75 mx-auto" style="background:#c0d8ff; border-color:#7aa3d0;">
    <div class="card-body">
      <h5 class="card-title">Estado meteorológico</h5>
      <p class="card-text">
        <i class="bi" id="weather-icon"></i>
        <span id="weather">{{ state['weather'] }}</span> -
        <i class="bi bi-thermometer-half"></i> {{ "%.1f"|format(state['temperature']) }} °C -
        <i class="bi bi-wind"></i> {{ "%.1f"|format(state['wind_speed']) }} km/h
      </p>
    </div>
  </div>
  <div class="card mb-3 w-75 mx-auto">
    <div class="card-body">
      <h5 class="card-title"><i class="bi bi-speedometer2"></i> Lecturas actuales</h5>
      <p class="mb-1"><i class="bi bi-water"></i> Nivel: <strong>{{ "%.2f"|format(state['water_level']) }} m</strong></p>
      <p class="mb-1"><i class="bi bi-speedometer"></i> Presión: <strong>{{ "%.2f"|format(state['pressure']) }} bar</strong></p>
      <p class="mb-1"><i class="bi bi-tropical-storm"></i> Caudal: <strong>{{ "%.2f"|format(state['flow']) }} m³/s</strong></p>
      <p class="mb-1"><i class="bi bi-box"></i> Peso aprox: <strong>{{ "%.2f"|format(state['water_level']*1000) }} toneladas</strong></p>
      <p class="mb-1"><i class="bi bi-droplet-half"></i> Temp. agua: <strong>{{ "%.1f"|format(state['water_temp']) }} °C</strong></p>
      <p class="mb-1"><i class="bi bi-thermometer"></i> Temp. turbinas: <strong>{{ "%.1f"|format(state['turbine_temps'][0]) }} °C</strong></p>
      <p class="mb-1"><i class="bi bi-speedometer"></i> RPM promedio: <strong>{{ "%.0f"|format(state['rpm_avg']) }} rpm</strong></p>
      <p class="mb-1"><i class="bi bi-lightning-fill"></i> Potencia total: <strong>{{ "%.2f"|format(state['power']) }} MW</strong></p>
      {% set weight = state['water_level']*1000 %}
      {% if weight >= WEIGHT_WARN or state['pressure'] >= PRESSURE_WARN %}
      <div class="alert alert-danger mt-2">⚠️ Riesgo crítico de colapso</div>
      {% endif %}
    </div>
  </div>
  <div id="map" class="mb-3">
    <div id="cam-overlay" class="cam-overlay">CAMERA 1 - Presa Tramuntana <span id="cam-time"></span></div>
    <div id="city">
      <div class="house" style="left:50px"></div>
      <div class="house" style="left:100px"></div>
      <div class="house" style="left:150px"></div>
      <div class="house" style="left:200px"></div>
    </div>
    <div id="dam">
      {% for g in range(state['gates']|length) %}
      <div id="gate{{g}}" class="gate"></div>
      <div id="flow{{g}}" class="flow" style="left:{{5+20*g}}px"></div>
      {% endfor %}
    </div>
  <div id="water"></div>
  <div id="flood"></div>
  <div class="cam-cross"></div>
  </div>

  <div id="gatecam" class="mb-3">
    <div id="cam2-overlay" class="cam-overlay">CAMERA 2 - Compuertas</div>
    <div id="dam2">
      {% for g in range(state['gates']|length) %}
      <div id="gate2_{{g}}" class="gate2"></div>
      <div id="flow2_{{g}}" class="flow2" style="left:{{10+30*g}}px"></div>
      {% endfor %}
    </div>
    <div id="water2"></div>
    <div class="cam-cross"></div>
  </div>

  <div class="row my-3">
    {% for g in range(state['gates']|length) %}
    <div class="col-md-4 text-center">
      <img src="https://dummyimage.com/200x120/333/fff&text=Turbina+{{g+1}}" class="img-fluid mb-1" alt="camara turbina {{g+1}}">
      <div><i class="bi bi-thermometer"></i> {{ "%.1f"|format(state['turbine_temps'][g]) }} °C</div>
      <div><i class="bi bi-speedometer"></i> {{ "%.0f"|format(state['turbine_rpm'][g]) }} rpm</div>
      <div><i class="bi bi-lightning-fill"></i> {{ "%.1f"|format(state['turbine_rpm'][g]*0.05) }} MW</div>
      {% if state['turbine_broken'][g] %}<div class="text-danger">Turbina rota</div>{% endif %}
    </div>
    {% endfor %}
  </div>
  {% if session and session['role'] in ['engineer','admin'] %}
  <div class="mb-4">
    {% for g in range(state['gates']|length) %}
    <div class="btn-group m-1" role="group">
      <form action="{{ url_for('gate', gid=g, action='open') }}" method="post">
        <button class="btn btn-sm btn-danger">Abrir {{g+1}}</button>
      </form>
      <form action="{{ url_for('gate', gid=g, action='close') }}" method="post">
        <button class="btn btn-sm btn-primary">Cerrar {{g+1}}</button>
      </form>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <canvas id="chartGeneral" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartLevel" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartPressure" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartFlow" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartWeight" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartPower" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartWaterTemp" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartTurbineTemp" height="80"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartRPM" height="80"></canvas>
    </div>
  </div>
  <script>
    const st = {{ state|tojson }};
    const weatherIcon = document.getElementById('weather-icon');
    if(st.weather === 'lluvia fuerte') weatherIcon.classList.add('bi-cloud-lightning-rain');
    else if(st.weather === 'lluvia') weatherIcon.classList.add('bi-cloud-rain');
    else weatherIcon.classList.add('bi-brightness-high');
    const water = document.getElementById('water');
    const perc = Math.min(st.water_level / {{ MAX_LEVEL }} * 100, 150);
    water.style.height = perc + '%';
    const water2 = document.getElementById('water2');
    if(water2) water2.style.height = perc + '%';
    for(let i=0;i<st.gates.length;i++){
      if(st.gates[i]){
        document.getElementById('gate'+i).style.background = '#0f0';
        document.getElementById('flow'+i).style.display = 'block';
        const g2=document.getElementById('gate2_'+i);
        const f2=document.getElementById('flow2_'+i);
        if(g2) g2.style.background='#0f0';
        if(f2) f2.style.display='block';
      }
    }
    if(st.dam_broken || st.water_level > {{ MAX_LEVEL }} ){
      document.getElementById('flood').style.display='block';
    }

    const hist = {{ history_json|safe }};
    const labels = hist.time.map(t => new Date(t*1000).toLocaleTimeString());
    const weight = hist.water_level.map(v => v*1000);
    const warnWeight = hist.time.map(()=> {{ WEIGHT_WARN }});
    const maxWeight = hist.time.map(()=> {{ WEIGHT_MAX }});
    const warnPressureLine = hist.time.map(()=> {{ PRESSURE_WARN }});
    const maxPressureLine = hist.time.map(()=> {{ PRESSURE_MAX }});
    const dataGeneral = {
      labels: labels,
      datasets:[
        {label:'Nivel', data:hist.water_level, borderColor:'blue', fill:false},
        {label:'Presión', data:hist.pressure, borderColor:'red', fill:false},
        {label:'Caudal', data:hist.flow, borderColor:'green', fill:false},
        {label:'Peso', data:weight, borderColor:'orange', fill:false},
        {label:'RPM', data:hist.rpm, borderColor:'brown', fill:false}
      ]
    };
    new Chart(document.getElementById('chartGeneral'), {type:'line', data:dataGeneral});

    new Chart(document.getElementById('chartLevel'), {
      type:'line',
      data:{
        labels:labels,
        datasets:[
          {label:'Nivel', data:hist.water_level, borderColor:'blue', fill:false},
          {label:'Aviso', data:hist.time.map(()=> {{ WEIGHT_WARN/1000 }}), borderColor:'orange', borderDash:[5,5], fill:false},
          {label:'Máximo', data:hist.time.map(()=> {{ WEIGHT_MAX/1000 }}), borderColor:'red', borderDash:[5,5], fill:false}
        ]
      }
    });

    new Chart(document.getElementById('chartPressure'), {
      type:'line',
      data:{
        labels:labels,
        datasets:[
          {label:'Presión', data:hist.pressure, borderColor:'red', fill:false},
          {label:'Aviso', data:warnPressureLine, borderColor:'orange', borderDash:[5,5], fill:false},
          {label:'Máximo', data:maxPressureLine, borderColor:'black', borderDash:[5,5], fill:false}
        ]
      }
    });

    new Chart(document.getElementById('chartFlow'), {
      type:'line',
      data:{labels:labels, datasets:[{label:'Caudal', data:hist.flow, borderColor:'green', fill:false}]}
    });

    new Chart(document.getElementById('chartWeight'), {
      type:'line',
      data:{
        labels:labels,
        datasets:[
          {label:'Peso', data:weight, borderColor:'orange', fill:false},
          {label:'Aviso', data:warnWeight, borderColor:'orange', borderDash:[5,5], fill:false},
          {label:'Máximo', data:maxWeight, borderColor:'red', borderDash:[5,5], fill:false}
        ]
      }
    });

    new Chart(document.getElementById('chartPower'), {
      type:'line',
      data:{labels:labels, datasets:[{label:'Potencia', data:hist.power, borderColor:'purple', fill:false}]}
    });

    new Chart(document.getElementById('chartWaterTemp'), {
      type:'line',
      data:{labels:labels, datasets:[{label:'Temp Agua', data:hist.water_temp, borderColor:'cyan', fill:false}]}
    });

    new Chart(document.getElementById('chartTurbineTemp'), {
      type:'line',
      data:{labels:labels, datasets:[{label:'Temp Turbina', data:hist.turbine_temp, borderColor:'magenta', fill:false}]}
    });

    new Chart(document.getElementById('chartRPM'), {
      type:'line',
      data:{labels:labels, datasets:[{label:'RPM', data:hist.rpm, borderColor:'brown', fill:false}]}
    });
    document.getElementById('cam-time').textContent = new Date().toLocaleTimeString();
    setTimeout(()=>location.reload(),3000);
  </script>
</body>
</html>
