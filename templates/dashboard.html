<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>HydroConsole Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container py-4">
  <h1>Presa de Tramuntana</h1>
  <p>Bienvenido {{ user }} ({{ role }})</p>
  <p>Clima actual: <strong>{{ state['weather'] }}</strong></p>
  <ul>
    <li><i class="bi bi-water"></i> Nivel de agua: {{ "%.2f"|format(state['water_level']) }} m</li>
    <li><i class="bi bi-speedometer"></i> Presión: {{ "%.2f"|format(state['pressure']) }} bar</li>
    <li><i class="bi bi-tropical-storm"></i> Caudal de salida: {{ "%.2f"|format(state['flow']) }} m³/s</li>
    <li><i class="bi bi-box"></i> Peso aprox.: {{ "%.2f"|format(state['water_level']*1000) }} t</li>
  </ul>
  {% if state['water_level'] > 250 or state['pressure'] > 280 %}
  <div class="alert alert-danger">⚠️ Riesgo crítico de colapso</div>
  {% endif %}

  <h2>Compuertas</h2>
  <ul>
  {% for g in range(state['gates']|length) %}
    <li>Puerta {{ g+1 }}: {{ 'abierta' if state['gates'][g] else 'cerrada' }}
    {% if role in ['engineer','admin'] %}
      <form action="{{ url_for('gate', gid=g, action='open') }}" method="post" class="d-inline">
        <button class="btn btn-sm btn-danger">Abrir</button>
      </form>
      <form action="{{ url_for('gate', gid=g, action='close') }}" method="post" class="d-inline">
        <button class="btn btn-sm btn-primary">Cerrar</button>
      </form>
    {% endif %}
    </li>
  {% endfor %}
  </ul>

  <h2>Historial de Lecturas</h2>
  <canvas id="chart" height="100"></canvas>

  <script>
    const history = {{ history_json|safe }};
    const labels = history.time.map(t => new Date(t*1000).toLocaleTimeString());
    const data = {
      labels: labels,
      datasets: [
        {label: 'Nivel', data: history.water_level, borderColor: 'blue', fill:false},
        {label: 'Presión', data: history.pressure, borderColor: 'red', fill:false},
        {label: 'Caudal', data: history.flow, borderColor: 'green', fill:false}
      ]
    };
    new Chart(document.getElementById('chart'), {type:'line', data});
    setTimeout(() => location.reload(), 3000);
  </script>
</body>
</html>
